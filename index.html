<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <title>広告動画再生</title>
  <style>
    body {
      margin: 0;
      background-color: #f4f4f4;
      font-family: sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }

    .phone-frame {
      width: 100%;
      height: 100%;
      background-color: #fff;
      position: relative;
      overflow: hidden;
    }

    iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    .button-container {
      position: absolute;
      bottom: 20px;
      width: 100%;
      text-align: center;
      display: none;
    }

    button {
      padding: 12px 24px;
      font-size: 16px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    .close-icon {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 24px;
      color: #ffffff;
      cursor: pointer;
      display: none;
    }

    .countdown-ring {
      position: absolute;
      bottom: 100px;
      right: 10px;
      width: 40px;
      height: 80px;
      display: none;
      justify-content: center;
      align-items: center;
    }

    svg {
      position: absolute;
      transform: rotate(-90deg);
    }

    circle {
      fill: none;
      stroke-width: 4;
    }

    .background {
      stroke: #c1c1c1;
    }

    .progress {
      stroke: #ffffff;
      stroke-dasharray: 220;
      stroke-dashoffset: 0;
      transition: stroke-dashoffset 1s linear;
    }

    .countdown-number {
      position: absolute;
      font-size: 12px;
      font-weight: bold;
      color: #ffffff;
    }
  </style>
</head>

<body>

  <div class="phone-frame">
    <div class="close-icon" onclick="closeVideo()">X</div>
    <iframe id="ytplayer" width="560" height="315" frameborder="0" allowfullscreen controls="1"></iframe>
    <div class="button-container" id="couponBtn">
      <button onclick="alert('クーポンコード: ZONEFREE2025')">クーポンコードをゲット</button>
    </div>
    <div class="countdown-ring" id="countdownRing">
      <svg width="30" height="30">
        <circle class="background" cx="15" cy="15" r="12"></circle>
        <circle class="progress" cx="15" cy="15" r="12"></circle>
      </svg>
      <div class="countdown-number" id="countdownText">15</div>
    </div>
  </div>

  <script>
    let player;
    let isVideoStarted = false;
    let videoStartTime = 0;
    let totalTimeWatched = 0;
    const duration = 15000;

    function onYouTubeIframeAPIReady() {
      player = new YT.Player('ytplayer', {
        events: {
          'onStateChange': onPlayerStateChange
        }
      });
    }

    function onPlayerStateChange(event) {
      if (event.data == YT.PlayerState.PLAYING) {
        if (!isVideoStarted) {
          isVideoStarted = true;
          if (totalTimeWatched == 0)
            document.getElementById("countdownRing").style.display = "flex";
          startTimer();
        }
        videoStartTime = Date.now();
      } else if (event.data == YT.PlayerState.PAUSED) {
        totalTimeWatched += Date.now() - videoStartTime;
        isVideoStarted = false
      } else if (event.data == YT.PlayerState.ENDED) {
        isVideoStarted = false;
        totalTimeWatched = 0;
      }
    }

    function startTimer() {
      const interval = setInterval(() => {
        if (!isVideoStarted || totalTimeWatched >= duration) {
          clearInterval(interval);
          return;
        }
        let time = totalTimeWatched;
        time += Date.now() - videoStartTime;
        document.getElementById("countdownText").textContent = Math.ceil((duration - time) / 1000);
        const progress = document.querySelector(".progress");
        const circleLength = 2 * Math.PI * 12;
        const offset = ((-time) / duration) * circleLength;
        progress.style.strokeDashoffset = offset;

        console.log(time)
        if (time >= duration) {
          document.getElementById("couponBtn").style.display = "block";
          document.querySelector(".close-icon").style.display = "block";
          document.getElementById("countdownRing").style.display = "none";
          clearInterval(interval);
        }
      }, 1000);
    }

    function closeVideo() {
      document.querySelector('.phone-frame').innerHTML = '<h2 style="text-align:center;margin-top:50%;">動画を閉じました</h2>';
    }

    function getVideo() {
      const videoIds = [
        "LDU_Txk06tM",
        "9mC1esFKvHA",
        "oP754adgi1A",
        "9bZkp7q19f0",
        "G6uI6fB4IE8",
      ];
      const key = "videoOpened";
      let used = JSON.parse(localStorage.getItem(key)) || [];

      if (used.length >= videoIds.length) {
        used = [];
      }

      let index;
      do {
        index = Math.floor(Math.random() * videoIds.length);
      } while (used.includes(index));

      used.push(index);
      localStorage.setItem(key, JSON.stringify(used));
      return videoIds[index];
    }

    const baseURL = "https://www.youtube.com/embed";
    const videoId = getVideo();
    document.getElementById("ytplayer").src = `${baseURL}/${videoId}?autoplay=1&controls=0&enablejsapi=1&modestbranding=1`;
  </script>
  <script src="https://www.youtube.com/iframe_api"></script>

</body>

</html>